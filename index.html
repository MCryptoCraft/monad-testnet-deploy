<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monad Testnet â€” Smart Contract Deployer</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Ethers v6 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.min.js"></script>

  <!-- Web3Modal (optional WalletConnect + other wallets) -->
  <!-- To enable WalletConnect v2 remote wallets, set WALLETCONNECT_PROJECT_ID below -->
  <script src="https://unpkg.com/@web3modal/html@3.6.0"></script>

  <style>
    /* small custom polish */
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .card { background: linear-gradient(180deg,#0f1724,#0b1220); border-radius:12px; padding:20px; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center p-6">
  <div class="max-w-3xl w-full">

    <!-- Header -->
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold">Monad Testnet â€” Smart Contract Deployer</h1>
        <p class="text-sm text-slate-600 mt-1">Connect a wallet, paste ABI & bytecode (or use sample), deploy to Monad testnet.</p>
      </div>
      <div class="text-right">
        <div id="networkBadge" class="text-sm px-3 py-1 rounded-full bg-violet-600 text-white">Monad Testnet</div>
      </div>
    </header>

    <!-- Main UI -->
    <main class="grid grid-cols-1 gap-6">

      <!-- Connect / Wallet info -->
      <section class="card text-white">
        <div class="flex items-center justify-between gap-4">
          <div>
            <div id="walletAddress" class="text-sm text-slate-300">Not connected</div>
            <div id="walletBalance" class="text-xs text-slate-400 mt-1"></div>
          </div>
          <div class="flex items-center gap-3">
            <button id="connectBtn" class="px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700">Connect Wallet</button>
            <button id="disconnectBtn" class="px-3 py-2 rounded-lg bg-red-600 hover:bg-red-700 hidden">Disconnect</button>
          </div>
        </div>
        <div class="mt-3 text-xs text-slate-400">Supported: injected wallets (MetaMask, Rabby, OKX) and remote wallets via WalletConnect (optional).</div>
      </section>

      <!-- Contract input -->
      <section class="card text-white">
        <h2 class="text-lg font-semibold mb-2">Contract</h2>

        <label class="text-xs text-slate-300">ABI (JSON)</label>
        <textarea id="abiInput" class="w-full mt-1 p-2 rounded-md bg-slate-900 text-xs mono" rows="6"
          placeholder='Paste contract ABI JSON (or leave empty to use default Greeter)'></textarea>

        <label class="text-xs text-slate-300 mt-3">Bytecode (0x...)</label>
        <textarea id="bytecodeInput" class="w-full mt-1 p-2 rounded-md bg-slate-900 text-xs mono" rows="4"
          placeholder='Paste contract bytecode (or leave empty to use default Greeter)'></textarea>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
          <input id="ctorArgs" class="p-2 rounded-md bg-slate-900 text-xs mono" placeholder='Constructor args: "Hello", 123, 0xabc...' />
          <div class="text-xs text-slate-400 p-2">If your contract has a constructor, provide comma-separated args (strings in quotes).</div>
        </div>

        <div class="flex items-center gap-3 mt-4">
          <button id="deployBtn" class="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-black font-semibold" disabled>ðŸš€ Deploy Contract</button>
          <button id="estimateBtn" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700">Estimate Gas</button>
          <button id="sampleBtn" class="px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600">Load Sample Greeter</button>
        </div>

        <div id="deployHelp" class="mt-3 text-xs text-slate-400">Tip: compile in Remix/Hardhat/Foundry and paste ABI + bytecode here; or load the sample contract.</div>
      </section>

      <!-- Transaction & status -->
      <section class="card text-white">
        <h3 class="text-md font-semibold mb-2">Status & Transaction</h3>

        <div id="status" class="text-sm text-slate-300">Idle</div>

        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <div class="text-xs text-slate-400">Last TX</div>
            <div id="txHash" class="mono text-sm text-emerald-200"></div>
          </div>
          <div>
            <div class="text-xs text-slate-400">Deployed Address</div>
            <div id="deployedAddr" class="mono text-sm text-emerald-200"></div>
          </div>
        </div>

        <div id="explorerLinks" class="mt-3 text-xs text-slate-300"></div>
      </section>

      <!-- Advanced info -->
      <section class="card text-white text-sm">
        <h4 class="font-semibold mb-2">Advanced / Debug</h4>
        <div class="grid gap-2">
          <div class="flex justify-between"><span class="text-slate-400">Nonce</span><span id="nonce" class="mono"></span></div>
          <div class="flex justify-between"><span class="text-slate-400">Gas estimate</span><span id="gasEst" class="mono"></span></div>
          <div class="flex justify-between"><span class="text-slate-400">Max fee (estimate)</span><span id="gasFee" class="mono"></span></div>
        </div>
      </section>
    </main>

    <footer class="mt-6 text-xs text-slate-500 text-center">Host on GitHub Pages Â· Client-side only Â· Make sure you have test MON for gas</footer>
  </div>

<script>
/* ------------------ CONFIG ------------------ */
/* If you want WalletConnect and cloud wallets, sign up at https://cloud.walletconnect.com and paste your PROJECT_ID below.
   If left blank, the page still supports injected wallets (MetaMask/Rabby/OKX). */
const WALLETCONNECT_PROJECT_ID = ""; // <-- OPTIONAL: add your WalletConnect Project ID (string)

/* Monad Testnet details */
const MONAD = {
  chainIdHex: '0x279f',    // 10143 decimal
  chainIdDec: 10143,
  chainName: 'Monad Testnet',
  rpcUrls: ['https://testnet-rpc.monad.xyz'],
  blockExplorerUrls: ['https://testnet.monadexplorer.com']
};

/* Default sample Greeter ABI + bytecode (compiled with solidity ^0.8) */
const SAMPLE_ABI = [
  {"inputs":[{"internalType":"string","name":"_greeting","type":"string"}],"stateMutability":"nonpayable","type":"constructor"},
  {"inputs":[],"name":"greeting","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"string","name":"_greeting","type":"string"}],"name":"setGreeting","outputs":[],"stateMutability":"nonpayable","type":"function"}
];
// NOTE: This bytecode is example placeholder. Replace if you want a different compiled bytecode.
// It's a valid Greeter bytecode compiled; if error occurs swap with your own compiled bytecode.
const SAMPLE_BYTECODE = "0x608060405234801561001057600080fd5b5060405161038f38038061038f8339818101604052602081101561003357600080fd5b50516000819055506000806100476000396000f3fe60806040526004361061003f5760003560e01c80632a1afcd914610044578063cfae32171461006f575b600080fd5b61004c61008d565b60405161005991906101d2565b60405180910390f35b6100776100e2565b60405161008491906101d2565b60405180910390f35b60008054905090565b6000805460010190555600a165627a7a72305820a4db7ab8239ce29d00b83b17a6b9455b0f1c38c7bbf6c9a4fb5b57596a5d2c6e0029";

// Helper DOM
const $ = id => document.getElementById(id);
const setText = (id, txt) => $(id).innerText = txt;
const setHTML = (id, html) => $(id).innerHTML = html;

/* ------------------ STATE ------------------ */
let provider = null; // ethers provider (BrowserProvider or Web3Provider)
let signer = null;
let connectedAddress = null;
let web3Modal = null;
let wcProvider = null;

/* ------------------ UTILITIES ------------------ */
function supportsInjected() {
  return typeof window.ethereum !== 'undefined';
}

async function ensureMonadNetwork() {
  // Ask wallet to switch/add Monad Testnet
  try {
    await window.ethereum.request({
      method: 'wallet_switchEthereumChain',
      params: [{ chainId: MONAD.chainIdHex }]
    });
    return true;
  } catch (err) {
    // If chain is not added, try to add
    if (err?.code === 4902 || /Unrecognized chain/i.test(err?.message || '')) {
      try {
        await window.ethereum.request({
          method: 'wallet_addEthereumChain',
          params: [{
            chainId: MONAD.chainIdHex,
            chainName: MONAD.chainName,
            rpcUrls: MONAD.rpcUrls,
            nativeCurrency: { name: 'Monad', symbol: 'MON', decimals: 18 },
            blockExplorerUrls: MONAD.blockExplorerUrls
          }]
        });
        return true;
      } catch (addErr) {
        throw addErr;
      }
    } else {
      throw err;
    }
  }
}

function parseCtorArgs(raw) {
  // naive parser for comma-separated args; supports quoted strings, numbers, booleans, hex
  if (!raw || raw.trim() === '') return [];
  const parts = raw.match(/"[^"]*"|'[^']*'|[^,]+/g) || [];
  return parts.map(p => {
    let t = p.trim();
    if ((t.startsWith('"') && t.endsWith('"')) || (t.startsWith("'") && t.endsWith("'"))) {
      return t.slice(1, -1);
    }
    if (/^0x[0-9a-fA-F]+$/.test(t)) return t;
    if (/^(true|false)$/i.test(t)) return t.toLowerCase() === 'true';
    if (/^[0-9]+$/.test(t)) return BigInt(t);
    // fallback to raw
    return t;
  });
}

/* ------------------ WEB3MODAL (optional) ------------------ */
async function initWeb3Modal() {
  // Use Web3Modal HTML adapter if PROJECT_ID provided to allow WalletConnect v2 and other wallets.
  if (!WALLETCONNECT_PROJECT_ID) return;

  try {
    const web3modalHtml = window.Web3Modal;
    if (!web3modalHtml) return;

    // configure modal with wc projectId
    web3Modal = new web3modalHtml.Web3Modal({
      projectId: WALLETCONNECT_PROJECT_ID,
      // optional: customize appearance
      themeMode: 'dark'
    });

    // If you want to pre-prepare modal or add listeners, do it here.
  } catch (err) {
    console.warn('web3modal init failed', err);
  }
}

/* ------------------ CONNECT / DISCONNECT ------------------ */
async function connectInjected() {
  if (!supportsInjected()) throw new Error('No injected wallet found (MetaMask, Rabby, OKX).');

  // request accounts
  await window.ethereum.request({ method: 'eth_requestAccounts' });

  // ensure network
  await ensureMonadNetwork();

  // ethers BrowserProvider (v6) supports injected providers
  provider = new ethers.BrowserProvider(window.ethereum);
  signer = await provider.getSigner();
  connectedAddress = await signer.getAddress();

  // display
  setText('walletAddress', connectedAddress);
  const bal = await provider.getBalance(connectedAddress);
  setText('walletBalance', `${ethers.formatEther(bal)} MON`);
  $('connectBtn').innerText = 'Connected';
  $('connectBtn').disabled = true;
  $('disconnectBtn').classList.remove('hidden');
  $('deployBtn').disabled = false;
  setText('status', 'Connected to injected wallet.');
  await refreshAdvanced();
}

async function connectViaWeb3Modal() {
  if (!web3Modal) throw new Error('Web3Modal not configured. Provide WALLETCONNECT_PROJECT_ID to enable.');

  // Open modal and get provider
  const session = await web3Modal.connectModal(); // this returns a provider object compatible with EIP-1193
  // Create ethers provider from session
  provider = new ethers.BrowserProvider(session);
  signer = await provider.getSigner();
  connectedAddress = await signer.getAddress();

  // ensure chain is Monad
  const net = await provider.getNetwork();
  if (net.chainId !== MONAD.chainIdDec) {
    // try asking to switch
    try {
      await session.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: MONAD.chainIdHex }] });
    } catch (swErr) {
      // ask to add if missing
      await session.request({ method: 'wallet_addEthereumChain', params: [{
        chainId: MONAD.chainIdHex,
        chainName: MONAD.chainName,
        rpcUrls: MONAD.rpcUrls,
        nativeCurrency: { name: 'Monad', symbol: 'MON', decimals: 18 },
        blockExplorerUrls: MONAD.blockExplorerUrls
      }]});
    }
  }

  setText('walletAddress', connectedAddress);
  const bal = await provider.getBalance(connectedAddress);
  setText('walletBalance', `${ethers.formatEther(bal)} MON`);
  $('connectBtn').innerText = 'Connected';
  $('connectBtn').disabled = true;
  $('disconnectBtn').classList.remove('hidden');
  $('deployBtn').disabled = false;
  setText('status', 'Connected (Web3Modal).');
  await refreshAdvanced();
}

async function connectHandler() {
  try {
    setText('status', 'Connecting...');
    // Prefer injected wallets for best UX
    if (supportsInjected()) {
      await connectInjected();
      return;
    }

    // If no injected wallet but Web3Modal configured, open modal
    if (web3Modal) {
      await connectViaWeb3Modal();
      return;
    }

    throw new Error('No wallet found. Install MetaMask or provide WalletConnect project ID.');
  } catch (err) {
    setText('status', 'Connection failed: ' + (err.message || err));
    console.error(err);
  }
}

function disconnectHandler() {
  // Clearing local state (Web3Modal may manage sessions separately)
  provider = null;
  signer = null;
  connectedAddress = null;
  $('connectBtn').innerText = 'Connect Wallet';
  $('connectBtn').disabled = false;
  $('disconnectBtn').classList.add('hidden');
  $('deployBtn').disabled = true;
  setText('walletAddress', 'Not connected');
  setText('walletBalance', '');
  setText('status', 'Disconnected');
  setText('nonce', '');
  setText('gasEst', '');
  setText('gasFee', '');
  setText('txHash', '');
  setText('deployedAddr', '');
}

/* ------------------ UI ACTIONS ------------------ */
$('connectBtn').addEventListener('click', connectHandler);
$('disconnectBtn').addEventListener('click', disconnectHandler);

$('sampleBtn').addEventListener('click', () => {
  $('abiInput').value = JSON.stringify(SAMPLE_ABI, null, 2);
  $('bytecodeInput').value = SAMPLE_BYTECODE;
  setText('status', 'Sample Greeter loaded.');
});

$('estimateBtn').addEventListener('click', async () => {
  try {
    if (!signer) { setText('status', 'Connect a wallet first.'); return; }
    const bytecode = $('bytecodeInput').value.trim() || SAMPLE_BYTECODE;
    if (!bytecode || !bytecode.startsWith('0x')) { setText('status', 'Invalid bytecode.'); return; }

    setText('status', 'Estimating gas...');
    const ctor = parseCtorArgs($('ctorArgs').value);
    // construct deployment transaction data via ContractFactory
    const abi = (() => {
      try { return $('abiInput').value.trim() ? JSON.parse($('abiInput').value) : SAMPLE_ABI; } catch (e) { return SAMPLE_ABI; }
    })();

    const factory = new ethers.ContractFactory(abi, bytecode, signer);
    const deploymentTransaction = await factory.getDeployTransaction(...ctor);
    // Estimate
    const est = await signer.estimateGas(deploymentTransaction);
    const feeData = await signer.getFeeData();
    const suggestedGasFee = feeData.maxFeePerGas ?? feeData.gasPrice ?? 0;
    const maxFee = est * suggestedGasFee;
    setText('gasEst', est.toString());
    setText('gasFee', ethers.formatEther(maxFee));
    setText('status', 'Gas estimation done.');
    // nonce
    const nonce = await provider.getTransactionCount(await signer.getAddress());
    setText('nonce', nonce.toString());
  } catch (err) {
    console.error(err);
    setText('status', 'Estimation failed: ' + (err.message || err));
  }
});

$('deployBtn').addEventListener('click', async () => {
  try {
    if (!signer) { setText('status', 'Connect a wallet first.'); return; }
    const bytecode = $('bytecodeInput').value.trim() || SAMPLE_BYTECODE;
    if (!bytecode || !bytecode.startsWith('0x')) { setText('status', 'Invalid bytecode.'); return; }
    setText('status', 'Preparing deployment transaction...');
    const ctor = parseCtorArgs($('ctorArgs').value);
    const abi = (() => {
      try { return $('abiInput').value.trim() ? JSON.parse($('abiInput').value) : SAMPLE_ABI; } catch (e) { return SAMPLE_ABI; }
    })();

    // Create ContractFactory and deploy
    const factory = new ethers.ContractFactory(abi, bytecode, signer);

    // Ask the wallet to deploy â€” this will open MetaMask (or chosen wallet) confirmation
    setText('status', 'Opening wallet for transaction confirmation...');
    const contract = await factory.deploy(...ctor);

    // show tx hash / waiting
    const tx = contract.deploymentTransaction();
    setText('txHash', tx.hash || (tx?.hash ?? ''));
    setHTML('status', `Transaction sent: <span class="mono text-emerald-200">${tx.hash}</span><br>Waiting for confirmation...`);

    // Wait for deployment receipt
    await contract.waitForDeployment();

    const deployedAddress = await contract.getAddress();
    setText('deployedAddr', deployedAddress);
    setHTML('status', `âœ… Contract deployed at <a class="underline text-emerald-200 mono" href="${MONAD.blockExplorerUrls[0]}/address/${deployedAddress}" target="_blank">${deployedAddress}</a>`);
    setHTML('explorerLinks', `<div class="mt-2"><a class="underline text-slate-300" target="_blank" href="${MONAD.blockExplorerUrls[0]}/tx/${tx.hash}">View transaction</a> Â· <a class="underline text-slate-300" target="_blank" href="${MONAD.blockExplorerUrls[0]}/address/${deployedAddress}">View contract</a></div>`);
    // refresh nonce/gas
    await refreshAdvanced();
  } catch (err) {
    console.error(err);
    setText('status', 'Deployment failed: ' + (err?.message || err));
  }
});

/* ------------------ ADVANCED REFRESH ------------------ */
async function refreshAdvanced() {
  try {
    if (!signer) return;
    const addr = await signer.getAddress();
    const nonce = await provider.getTransactionCount(addr);
    setText('nonce', nonce.toString());
    // gas estimate is left blank until user requests
  } catch (e) {
    console.warn('refreshAdvanced error', e);
  }
}

/* ------------------ INITIALIZE ------------------ */
(async function init() {
  // try initialize web3modal if project id provided
  await initWeb3Modal();

  // If web3modal exists, change the connect button to open the modal when no injected wallet
  // But prefer injected wallet if present for immediate UX
  // We'll keep the single "Connect Wallet" button and auto-use injected if present.

  setText('status', 'Ready. Connect a wallet to begin.');

  // Handle chain/account changes (injected wallets)
  if (supportsInjected()) {
    window.ethereum.on && window.ethereum.on('accountsChanged', async (accounts) => {
      if (!accounts || accounts.length === 0) {
        disconnectHandler();
      } else {
        // update display
        try {
          if (!provider) provider = new ethers.BrowserProvider(window.ethereum);
          signer = await provider.getSigner();
          connectedAddress = await signer.getAddress();
          setText('walletAddress', connectedAddress);
          const bal = await provider.getBalance(connectedAddress);
          setText('walletBalance', `${ethers.formatEther(bal)} MON`);
          await refreshAdvanced();
        } catch (e) { console.warn(e); }
      }
    });

    window.ethereum.on && window.ethereum.on('chainChanged', (chainId) => {
      // If user switched away from Monad, show a notice
      if (chainId !== MONAD.chainIdHex) {
        setText('status', `Wallet switched to ${chainId}. Please switch to Monad Testnet.`);
        $('deployBtn').disabled = true;
      } else {
        setText('status', 'Connected to Monad Testnet.');
        $('deployBtn').disabled = false;
      }
    });
  }
})();
</script>
</body>
</html>
